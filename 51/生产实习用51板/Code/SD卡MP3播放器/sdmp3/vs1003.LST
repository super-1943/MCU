C51 COMPILER V8.02   VS1003                                                                04/22/2011 18:12:42 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE VS1003
OBJECT MODULE PLACED IN vs1003.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE vs1003.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "vs1003.h"
   2          #include "patch.h"
   3          #include "myfun.h"
   4          #include "spi.h"
   5          
   6          /*******************************************************
   7          
   8                  +------------------------------------+
   9                  |  振南电子 高级外设模块 VS1003B 部分|
  10                  +------------------------------------+
  11          
  12            此源码版权属 振南 全权享有，如欲引用，敬请署名并告知
  13                  严禁随意用于商业目的，违者必究，后果自负
  14                   振南电子 
  15                       ->产品网站 http://www.znmcu.cn/
  16                       ->产品论坛 http://bbs.znmcu.cn/
  17                       ->产品网店 http://shop.znmcu.cn/
  18                       ->产品咨询 QQ:987582714 MSN:yzn07@126.com
  19                                  WW:yzn07                                  
  20          ********************************************************/
  21          
  22          /******************************************************************
  23           - 功能描述：向VS1003的功能寄存器中写入数据（一个字，即两个字节）
  24           - 隶属模块：VS1003B模块
  25           - 函数属性：外部，用户可调用
  26           - 参数说明：addr是功能寄存器的地址
  27                       hdat是要写入的高字节
  28                       ldat是要写入的低字节
  29           - 返回说明：无返回
  30           ******************************************************************/
  31          
  32          void VS_Write_Reg(unsigned char addr,unsigned char hdat,unsigned char ldat)
  33          {  
  34   1       VS_DREQ=1;           //51单片机IO作输入时先置为1
  35   1       while(!VS_DREQ);     //VS1003的DREQ为高电平时才接收数据
  36   1       VS_XCS=0;            //打开片选，SCI有效，这样才能对功能寄存器进行读写
  37   1       SPI_WriteByte(0x02);  //写入操作码0x02   00000010 （功能寄存器写操作）
  38   1       SPI_WriteByte(addr);  //写入寄存器地址
  39   1       SPI_WriteByte(hdat);  //写入高字节
  40   1       SPI_WriteByte(ldat);  //写入低字节   
  41   1       VS_XCS=1;            //关闭片选，SCI无效
  42   1      }
  43          
  44          /******************************************************************
  45           - 功能描述：从VS1003的功能寄存器中读取数据（一个字）
  46           - 隶属模块：VS1003B模块
  47           - 函数属性：外部，用户可调用
  48           - 参数说明：addr是功能寄存器的地址
  49           - 返回说明：返回从VS1003的功能寄存器中读到的值 
  50           ******************************************************************/
  51          
  52          unsigned int VS_Read_Reg(unsigned char addr) 
  53          {
  54   1       unsigned int temp=0;
  55   1       VS_DREQ=1;               
C51 COMPILER V8.02   VS1003                                                                04/22/2011 18:12:42 PAGE 2   

  56   1       while(!VS_DREQ); //VS1003的DREQ为高电平时才接收数据
  57   1      
  58   1       VS_XCS=0;            //打开片选，SCI有效
  59   1       SPI_WriteByte(0x03);  //读出操作码0x03   00000011（功能寄存器读操作）
  60   1       SPI_WriteByte(addr);  //写入寄存器地址
  61   1      
  62   1       temp=SPI_ReadByte();  //读高字节
  63   1       temp<<=8;
  64   1       temp|=SPI_ReadByte(); //读取低字节，与高字节拼成一个字
  65   1      
  66   1       VS_XCS=1;            //关闭片选，SCI无效
  67   1       return temp;     //返回读到的值
  68   1      }
  69          
  70          /******************************************************************
  71           - 功能描述：VS1003软复位及初始化（设置时钟频率及音量）
  72           - 隶属模块：VS1003B模块
  73           - 函数属性：外部，用户可调用
  74           - 参数说明：无
  75           - 返回说明：无
  76           ******************************************************************/
  77          
  78          void VS_Reset()
  79          {
  80   1       VS_XRESET=1; 
  81   1       delay(100);
  82   1       VS_XRESET=0;
  83   1       delay(100);
  84   1       VS_XRESET=1; //硬件复位，XRESET低电平有效
  85   1       delay(100);
  86   1      
  87   1       VS_Write_Reg(0x00,0x08,0x04);//软件复位，向0号寄存器写入0x0804   SM_SDINEW为1   SM_RESET为1
  88   1       VS_Write_Reg(0x03,0x98,0x00);//时钟设置，向3号寄存器写入0x9800   SC_MULT  为4   SC_ADD  为3   SC_FREQ为0
  89   1       VS_Write_Reg(0x0b,0x00,0x00);//音量设置，左右声道均最大音量
  90   1         
  91   1       VS_XDCS=0;          //打开数据片选，注意此时XCS（片选）为高电平，SDI有效
  92   1       SPI_WriteByte(0);    //写入数据，这里写入4个0，是无关数据，用来启动数据传输
  93   1       SPI_WriteByte(0);
  94   1       SPI_WriteByte(0);
  95   1       SPI_WriteByte(0);
  96   1       VS_XDCS=1;         //关闭数据片选，SDI无效
  97   1      } 
  98          
  99          /******************************************************************
 100           - 功能描述：向VS1003写入一个字节的音频数据（即用于播放的数据）
 101                          注：调用前先将VS_XDCS置为0，打开数据片选
 102           - 隶属模块：VS1003B模块
 103           - 函数属性：外部，用户可调用
 104           - 参数说明：dat是要写入的字节
 105           - 返回说明：无
 106           ******************************************************************/
 107          
 108          void VS_Send_Dat(unsigned char dat) 
 109          {
 110   1       VS_XDCS=0;    //打开SDI，此时可以向VS1003写入音频数据
 111   1       VS_DREQ=1;
 112   1       while(!VS_DREQ);  //VS1003的DREQ为高才能写入数据
 113   1       SPI_WriteByte(dat);//通过SPI向VS1003写入一个字节的音频数据
 114   1       VS_XDCS=1;   //关闭SDI
 115   1      }
 116          
 117          /******************************************************************
C51 COMPILER V8.02   VS1003                                                                04/22/2011 18:12:42 PAGE 3   

 118           - 功能描述：向VS1003写入2048个0，用于清空VS1003的数据缓冲区
 119                       注：在播放完一个完整的音频（如一首完整的MP3）后，调用
 120                       此函数，清空VS1003数据缓冲区，为下面的音频数据（如下
 121                       一首MP3）作准备。        
 122           - 隶属模块：VS1003B模块
 123           - 函数属性：外部，用户可调用
 124           - 参数说明：无
 125           - 返回说明：无
 126           ******************************************************************/
 127          
 128          void VS_Flush_Buffer() 
 129          {
 130   1       unsigned int i;
 131   1       VS_XDCS=0;        //打开数据片选，即开启SDI传输
 132   1       for(i=0;i<2048;i++)
 133   1       {
 134   2        VS_Send_Dat(0);
 135   2       }
 136   1       VS_XDCS=1;        //关闭数据片选
 137   1      }
 138          
 139          /******************************************************************
 140           - 功能描述：正弦测试，这是测试VS1003芯片是否正常的有效手段！！
 141           - 隶属模块：VS1003B模块
 142           - 函数属性：外部，用户可调用
 143           - 参数说明：x决定了正弦测试中产生的正弦波的频率，直接影响听到的
 144                       声音的频率      
 145           - 返回说明：无
 146           ******************************************************************/
 147          
 148          void VS_sin_test(unsigned char x)
 149          { 
 150   1       VS_Write_Reg(0x00,0x08,0x20);//启动测试，向0号寄存器写入0x0820   SM_SDINEW为1   SM_TEST为1
 151   1       VS_DREQ=1;
 152   1       while(!VS_DREQ);   //等待DREQ变为高电平
 153   1       VS_XDCS=0;         //打开数据片选 SDI有效
 154   1       SPI_WriteByte(0x53);//写入以下8个字节,进入正弦测试
 155   1       SPI_WriteByte(0xef); 
 156   1       SPI_WriteByte(0x6e);
 157   1       SPI_WriteByte(x);   //参数x用来调整正弦测试中正弦波的频率   FsIdx (b7~b5):采样率表索引   S (b4~b0):正弦波
             -的跃速   频率F=Fs X S / 128
 158   1       SPI_WriteByte(0);   //比如x=126 (0b 011 11110) FsIdx=011=3   Fs=22050Hz   S=11110=30    F=22050Hz X 30 /1
             -28 =5168 Hz
 159   1       SPI_WriteByte(0);
 160   1       SPI_WriteByte(0);
 161   1       SPI_WriteByte(0);
 162   1       delay(60000);      //这里延时一段时间，为了听到“正弦音”
 163   1       delay(60000);
 164   1       delay(60000);
 165   1       delay(60000);
 166   1       delay(60000);
 167   1       delay(60000);
 168   1       SPI_WriteByte(0x45);//写入以下8个字节，退出正弦测试
 169   1       SPI_WriteByte(0x78); 
 170   1       SPI_WriteByte(0x69);
 171   1       SPI_WriteByte(0x74);
 172   1       SPI_WriteByte(0);
 173   1       SPI_WriteByte(0);
 174   1       SPI_WriteByte(0);
 175   1       SPI_WriteByte(0);
 176   1       VS_XDCS=1;         //关闭数据片选 ，SDI无效
 177   1      } 
C51 COMPILER V8.02   VS1003                                                                04/22/2011 18:12:42 PAGE 4   

 178          
 179          /******************************************************************
 180           - 功能描述：为VS1003打补丁，获得实时频谱
 181                       注：atab与dtab是VS1003频谱功能补丁码，在patch.h中
 182           - 隶属模块：VS1003B模块
 183           - 函数属性：外部，用户可调用
 184           - 参数说明：无    
 185           - 返回说明：无
 186           ******************************************************************/
 187          
 188          void LoadPatch() 
 189          {
 190   1       unsigned int i;
 191   1       for(i=0;i<943;i++)
 192   1       {
 193   2        VS_Write_Reg(atab[i],dtab[i]>>8,dtab[i]&0xff);
 194   2       }
 195   1      }
 196          
 197          
 198          
 199           
 200          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    494    ----
   CONSTANT SIZE    =   2829    ----
   XDATA SIZE       =   ----      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

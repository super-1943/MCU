C51 COMPILER V8.02   UART                                                                  12/08/2009 07:58:17 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN UART.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE UART.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "at89x52.H"
   2          
   3          #include "UART.h"
   4          #include "my_type.h"
   5          #include "config.h"
   6          
   7          
   8          /********************************************************************
   9          函数功能：串口初始化。
  10          入口参数：无。
  11          返    回：无。
  12          备    注：无。
  13          ********************************************************************/
  14          void init_uart(void)
  15          {
  16   1              EA=0;
  17   1              TMOD&=0x0F;
  18   1              TMOD|=0x20;    //定时器1工作在模式2
  19   1              SCON=0x50;     //串口工作在模式1
  20   1              TCON=0x05;
  21   1              TH1=256-Fclk/(BitRate*12*16);
  22   1              TL1=256-Fclk/(BitRate*12*16); 
  23   1              PCON=0x80;    //串口波特率加倍
  24   1              ES=1;         //串行中断允许
  25   1              TR1=1;        //启动定时器1
  26   1              REN=1;        //允许接收 
  27   1              EA=1;         //允许中断
  28   1      }
  29          ////////////////////////End of function//////////////////////////////
  30          
  31            
  32          /********************************************************************
  33          函数功能：串口中断处理。
  34          入口参数：无。
  35          返    回：无。
  36          备    注：无。
  37          ********************************************************************/
  38          void UartISR(void) interrupt 4
  39          {
  40   1              if(RI)    //收到数据
  41   1              {
  42   2                      RI=0;   //清中断请求
  43   2                      SBUF=SBUF;
  44   2              }
  45   1              else      //发送完一字节数据
  46   1              {
  47   2                      TI=0;
  48   2              }
  49   1      }
  50          ////////////////////////End of function//////////////////////////////
  51          
  52          /********************************************************************
  53          函数功能：往串口发送一字节数据。
  54          入口参数：d: 要发送的字节数据。
  55          返    回：无。
C51 COMPILER V8.02   UART                                                                  12/08/2009 07:58:17 PAGE 2   

  56          备    注：无。
  57          ********************************************************************/
  58          void uart_putchar(uint8 d)
  59          {
  60   1              ES=0;
  61   1              SBUF=d;
  62   1              while(TI!=1);
  63   1              TI=0;
  64   1              ES=1;
  65   1      }
  66          ////////////////////////End of function//////////////////////////////
  67          
  68          /********************************************************************
  69          函数功能：发送一个字符串。
  70          入口参数：pd：要发送的字符串指针。
  71          返    回：无。
  72          备    注：无。
  73          ********************************************************************/
  74          void print_str(uint8 * pd)
  75          {
  76   1              while((*pd)!='\0')
  77   1              {
  78   2                      uart_putchar(*pd);
  79   2                      pd++;
  80   2              }
  81   1      }
  82          ////////////////////////End of function//////////////////////////////
  83          
  84          /********************************************************************
  85          函数功能：将整数转按十进制字符串发送。
  86          入口参数：x：待显示的整数。
  87          返    回：无。
  88          备    注：无。
  89          ********************************************************************/
  90          void print_longint(uint32 x)
  91          {
  92   1              int8 i;
  93   1              uint8 display_buffer[10];
  94   1              
  95   1              for(i=9;i>=0;i--)
  96   1              {
  97   2                      display_buffer[i]='0'+x%10;
  98   2                      x/=10;
  99   2              }
 100   1              for(i=0;i<9;i++)
 101   1              {
 102   2                      if(display_buffer[i]!='0')
 103   2                      {
 104   3                              break;
 105   3                      }
 106   2              }
 107   1              for(;i<10;i++)
 108   1              {
 109   2                      uart_putchar(display_buffer[i]);
 110   2              }
 111   1      }
 112          ////////////////////////End of function//////////////////////////////
 113          
 114          code uint8 HexTable[]={'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};
 115          /********************************************************************
 116          函数功能：将短整数按十六进制发送。
 117          入口参数：待发送的整数。
C51 COMPILER V8.02   UART                                                                  12/08/2009 07:58:17 PAGE 3   

 118          返    回：无。
 119          备    注：无。
 120          ********************************************************************/
 121          void print_16hex(uint16 x)
 122          {
 123   1              uint8 i;
 124   1              uint8 display_buffer[7];
 125   1              display_buffer[6]=0;
 126   1              display_buffer[0]='0';
 127   1              display_buffer[1]='x';
 128   1              for(i=5;i>=2;i--)
 129   1              {
 130   2                      display_buffer[i]=HexTable[(x&0xf)];
 131   2                      x>>=4;
 132   2              }
 133   1              print_str(display_buffer);
 134   1      }
 135          ////////////////////////End of function//////////////////////////////
 136          
 137          /********************************************************************
 138          函数功能：将整数按十六进制发送。
 139          入口参数：待发送的整数。
 140          返    回：无。
 141          备    注：无。
 142          ********************************************************************/
 143          
 144          void print_32hex(uint32 x)  //
 145          {
 146   1              uint8 i;
 147   1              uint8 display_buffer[11];
 148   1              display_buffer[10]=0;
 149   1              display_buffer[0]='0';
 150   1              display_buffer[1]='x';
 151   1              for(i=9;i>=2;i--)
 152   1              {
 153   2                      display_buffer[i]=HexTable[(x&0xf)];
 154   2                      x>>=4;
 155   2              }
 156   1      print_str(display_buffer);
 157   1      }
 158          
 159          ////////////////////////End of function//////////////////////////////
 160          
 161          
 162          /********************************************************************
 163          函数功能：发送一个byte的数据。
 164          入口参数：待发送的数据。
 165          返    回：无。
 166          备    注：无。
 167          ********************************************************************/
 168          
 169          ////////////////////////End of function//////////////////////////////
 170          
 171          /********************************************************************
 172          函数功能：以HEX格式发送一个byte的数据。
 173          入口参数：待发送的数据
 174          返    回：无。
 175          备    注：无。
 176          ********************************************************************/
 177          void print_hex(uint8 x)
 178          {
 179   1              uart_putchar('0');
C51 COMPILER V8.02   UART                                                                  12/08/2009 07:58:17 PAGE 4   

 180   1              uart_putchar('x');
 181   1              uart_putchar(HexTable[x>>4]);
 182   1              uart_putchar(HexTable[x&0xf]);
 183   1              uart_putchar(' ');
 184   1      }
 185          ////////////////////////End of function//////////////////////////////


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    368    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      37
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
